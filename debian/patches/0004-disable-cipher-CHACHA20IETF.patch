From: Roger Shimizu <rogershimizu@gmail.com>
Date: Tue, 11 Oct 2016 01:00:18 +0900
Subject: disable cipher CHACHA20IETF

CHACHA20IETF is not supported by libsodium in jessie

Signed-off-by: Roger Shimizu <rogershimizu@gmail.com>
Reviewed-by: Max Lv <max.c.lv@gmail.com>
Reviewed-by: Boyuan Yang <073plan@gmail.com>
---
 README.md                      |  3 +--
 doc/shadowsocks-libev.asciidoc |  4 ++--
 doc/ss-local.asciidoc          |  4 ++--
 doc/ss-manager.asciidoc        |  4 ++--
 doc/ss-redir.asciidoc          |  4 ++--
 doc/ss-server.asciidoc         |  4 ++--
 doc/ss-tunnel.asciidoc         |  4 ++--
 src/encrypt.c                  | 18 ++++++------------
 src/encrypt.h                  |  3 +--
 src/utils.c                    |  4 ++--
 10 files changed, 22 insertions(+), 30 deletions(-)

diff --git a/README.md b/README.md
index c52d13a..3ea343f 100644
--- a/README.md
+++ b/README.md
@@ -384,8 +384,7 @@ man pages of the applications, respectively.
                                   aes-128-cfb, aes-192-cfb, aes-256-cfb,
                                   bf-cfb, camellia-128-cfb, camellia-192-cfb,
                                   camellia-256-cfb, cast5-cfb, des-cfb, idea-cfb,
-                                  rc2-cfb, seed-cfb, salsa20 ,chacha20 and
-                                  chacha20-ietf
+                                  rc2-cfb, seed-cfb, salsa20 and chacha20
 
        [-f <pid_file>]            the file path to store pid
 
diff --git a/doc/shadowsocks-libev.asciidoc b/doc/shadowsocks-libev.asciidoc
index fd18eaa..936b880 100644
--- a/doc/shadowsocks-libev.asciidoc
+++ b/doc/shadowsocks-libev.asciidoc
@@ -50,11 +50,11 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 18 different ciphers:
+*Shadowsocks-libev* accepts 17 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'table'.
 +
diff --git a/doc/ss-local.asciidoc b/doc/ss-local.asciidoc
index 3ae49f9..ec4c1da 100644
--- a/doc/ss-local.asciidoc
+++ b/doc/ss-local.asciidoc
@@ -43,11 +43,11 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 18 different ciphers:
+*Shadowsocks-libev* accepts 17 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'table'.
 +
diff --git a/doc/ss-manager.asciidoc b/doc/ss-manager.asciidoc
index aae28c9..e4cfe88 100644
--- a/doc/ss-manager.asciidoc
+++ b/doc/ss-manager.asciidoc
@@ -41,11 +41,11 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 18 different ciphers:
+*Shadowsocks-libev* accepts 17 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'table'.
 +
diff --git a/doc/ss-redir.asciidoc b/doc/ss-redir.asciidoc
index d48e8a2..6a696e7 100644
--- a/doc/ss-redir.asciidoc
+++ b/doc/ss-redir.asciidoc
@@ -45,11 +45,11 @@ password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 18 different ciphers:
+*Shadowsocks-libev* accepts 17 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'table'.
 +
diff --git a/doc/ss-server.asciidoc b/doc/ss-server.asciidoc
index 8fda741..5bfba4d 100644
--- a/doc/ss-server.asciidoc
+++ b/doc/ss-server.asciidoc
@@ -41,11 +41,11 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 18 different ciphers:
+*Shadowsocks-libev* accepts 17 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'table'.
 +
diff --git a/doc/ss-tunnel.asciidoc b/doc/ss-tunnel.asciidoc
index 58dbe72..1d001c9 100644
--- a/doc/ss-tunnel.asciidoc
+++ b/doc/ss-tunnel.asciidoc
@@ -44,11 +44,11 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 18 different ciphers:
+*Shadowsocks-libev* accepts 17 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'table'.
 +
diff --git a/src/encrypt.c b/src/encrypt.c
index 0b8187d..d4bde1b 100644
--- a/src/encrypt.c
+++ b/src/encrypt.c
@@ -117,8 +117,7 @@ static const char *supported_ciphers[CIPHER_NUM] = {
     "rc2-cfb",
     "seed-cfb",
     "salsa20",
-    "chacha20",
-    "chacha20-ietf"
+    "chacha20"
 };
 
 #ifdef USE_CRYPTO_POLARSSL
@@ -139,8 +138,7 @@ static const char *supported_ciphers_polarssl[CIPHER_NUM] = {
     CIPHER_UNSUPPORTED,
     CIPHER_UNSUPPORTED,
     "salsa20",
-    "chacha20",
-    "chacha20-ietf"
+    "chacha20"
 };
 #endif
 
@@ -162,8 +160,7 @@ static const char *supported_ciphers_mbedtls[CIPHER_NUM] = {
     CIPHER_UNSUPPORTED,
     CIPHER_UNSUPPORTED,
     "salsa20",
-    "chacha20",
-    "chacha20-ietf"
+    "chacha20"
 };
 #endif
 
@@ -185,18 +182,17 @@ static const CCAlgorithm supported_ciphers_applecc[CIPHER_NUM] = {
     kCCAlgorithmRC2,
     kCCAlgorithmInvalid,
     kCCAlgorithmInvalid,
-    kCCAlgorithmInvalid,
     kCCAlgorithmInvalid
 };
 
 #endif
 
 static const int supported_ciphers_iv_size[CIPHER_NUM] = {
-    0, 0, 16, 16, 16, 16, 8, 16, 16, 16, 8, 8, 8, 8, 16, 8, 8, 12
+    0, 0, 16, 16, 16, 16, 8, 16, 16, 16, 8, 8, 8, 8, 16, 8, 8
 };
 
 static const int supported_ciphers_key_size[CIPHER_NUM] = {
-    0, 16, 16, 16, 24, 32, 16, 16, 24, 32, 16, 8, 16, 16, 16, 32, 32, 32
+    0, 16, 16, 16, 24, 32, 16, 16, 24, 32, 16, 8, 16, 16, 16, 32, 32
 };
 
 static int safe_memcmp(const void *s1, const void *s2, size_t n)
@@ -251,8 +247,6 @@ static int crypto_stream_xor_ic(uint8_t *c, const uint8_t *m, uint64_t mlen,
         return crypto_stream_salsa20_xor_ic(c, m, mlen, n, ic, k);
     case CHACHA20:
         return crypto_stream_chacha20_xor_ic(c, m, mlen, n, ic, k);
-    case CHACHA20IETF:
-        return crypto_stream_chacha20_ietf_xor_ic(c, m, mlen, n, (uint32_t)ic, k);
     }
     // always return 0
     return 0;
@@ -1438,7 +1432,7 @@ void enc_key_init(int method, const char *pass)
     cipher_kt_t *cipher;
     cipher_kt_t cipher_info;
 
-    if (method == SALSA20 || method == CHACHA20 || method == CHACHA20IETF) {
+    if (method == SALSA20 || method == CHACHA20) {
         if (sodium_init() == -1) {
             FATAL("Failed to initialize sodium");
         }
diff --git a/src/encrypt.h b/src/encrypt.h
index 158129b..10c6cda 100644
--- a/src/encrypt.h
+++ b/src/encrypt.h
@@ -119,7 +119,7 @@ typedef struct {
 #endif
 
 #define SODIUM_BLOCK_SIZE   64
-#define CIPHER_NUM          18
+#define CIPHER_NUM          17
 
 #define NONE                -1
 #define TABLE               0
@@ -139,7 +139,6 @@ typedef struct {
 #define SEED_CFB            14
 #define SALSA20             15
 #define CHACHA20            16
-#define CHACHA20IETF        17
 
 #define ONETIMEAUTH_FLAG 0x10
 #define ADDRTYPE_MASK 0xF
diff --git a/src/utils.c b/src/utils.c
index 5701824..fdafd4a 100644
--- a/src/utils.c
+++ b/src/utils.c
@@ -241,9 +241,9 @@ void usage()
     printf(
         "                                  camellia-256-cfb, cast5-cfb, des-cfb,\n");
     printf(
-        "                                  idea-cfb, rc2-cfb, seed-cfb, salsa20,\n");
+        "                                  idea-cfb, rc2-cfb, seed-cfb, salsa20 and\n");
     printf(
-        "                                  chacha20 and chacha20-ietf.\n");
+        "                                  chacha20.\n");
     printf(
         "                                  The default cipher is tables.\n");
     printf("\n");
