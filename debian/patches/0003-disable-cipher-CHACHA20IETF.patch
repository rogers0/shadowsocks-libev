From: Roger Shimizu <rogershimizu@gmail.com>
Date: Mon, 28 Nov 2016 01:23:49 +0900
Subject: disable cipher CHACHA20IETF

CHACHA20IETF is not supported by libsodium in jessie

Signed-off-by: Roger Shimizu <rogershimizu@gmail.com>
Reviewed-by: Max Lv <max.c.lv@gmail.com>
Reviewed-by: Boyuan Yang <073plan@gmail.com>
---
 README.md                      |  3 +--
 doc/shadowsocks-libev.asciidoc |  4 ++--
 doc/ss-local.asciidoc          |  4 ++--
 doc/ss-manager.asciidoc        |  4 ++--
 doc/ss-redir.asciidoc          |  4 ++--
 doc/ss-server.asciidoc         |  4 ++--
 doc/ss-tunnel.asciidoc         |  4 ++--
 src/encrypt.c                  | 19 ++++++-------------
 src/encrypt.h                  |  3 +--
 src/utils.c                    |  4 ++--
 10 files changed, 22 insertions(+), 31 deletions(-)

diff --git a/README.md b/README.md
index ea69e71..2d306d2 100644
--- a/README.md
+++ b/README.md
@@ -346,8 +346,7 @@ man pages of the applications, respectively.
                                   aes-128-cfb, aes-192-cfb, aes-256-cfb,
                                   bf-cfb, camellia-128-cfb, camellia-192-cfb,
                                   camellia-256-cfb, cast5-cfb, des-cfb, idea-cfb,
-                                  rc2-cfb, seed-cfb, salsa20 ,chacha20 and
-                                  chacha20-ietf
+                                  rc2-cfb, seed-cfb, salsa20 and chacha20
 
        [-f <pid_file>]            the file path to store pid
 
diff --git a/doc/shadowsocks-libev.asciidoc b/doc/shadowsocks-libev.asciidoc
index cfb5a49..d509452 100644
--- a/doc/shadowsocks-libev.asciidoc
+++ b/doc/shadowsocks-libev.asciidoc
@@ -50,12 +50,12 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 21 different ciphers:
+*Shadowsocks-libev* accepts 20 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb,
 aes-128-ctr, aes-192-ctr, aes-256-ctr, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'rc4-md5'.
 +
diff --git a/doc/ss-local.asciidoc b/doc/ss-local.asciidoc
index 10ce591..10625dd 100644
--- a/doc/ss-local.asciidoc
+++ b/doc/ss-local.asciidoc
@@ -43,12 +43,12 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 21 different ciphers:
+*Shadowsocks-libev* accepts 20 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb,
 aes-128-ctr, aes-192-ctr, aes-256-ctr, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'rc4-md5'.
 +
diff --git a/doc/ss-manager.asciidoc b/doc/ss-manager.asciidoc
index 6183b92..3d7cd83 100644
--- a/doc/ss-manager.asciidoc
+++ b/doc/ss-manager.asciidoc
@@ -41,12 +41,12 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 21 different ciphers:
+*Shadowsocks-libev* accepts 20 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb,
 aes-128-ctr, aes-192-ctr, aes-256-ctr, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'rc4-md5'.
 +
diff --git a/doc/ss-redir.asciidoc b/doc/ss-redir.asciidoc
index 6637f7f..1afce3e 100644
--- a/doc/ss-redir.asciidoc
+++ b/doc/ss-redir.asciidoc
@@ -45,12 +45,12 @@ password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 21 different ciphers:
+*Shadowsocks-libev* accepts 20 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb,
 aes-128-ctr, aes-192-ctr, aes-256-ctr, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'rc4-md5'.
 +
diff --git a/doc/ss-server.asciidoc b/doc/ss-server.asciidoc
index d8022ee..8ab967f 100644
--- a/doc/ss-server.asciidoc
+++ b/doc/ss-server.asciidoc
@@ -41,12 +41,12 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 21 different ciphers:
+*Shadowsocks-libev* accepts 20 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb,
 aes-128-ctr, aes-192-ctr, aes-256-ctr, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'rc4-md5'.
 +
diff --git a/doc/ss-tunnel.asciidoc b/doc/ss-tunnel.asciidoc
index 3979b19..417c6d7 100644
--- a/doc/ss-tunnel.asciidoc
+++ b/doc/ss-tunnel.asciidoc
@@ -44,12 +44,12 @@ Set the password. The server and the client should use the same password.
 -m <encrypt_method>::
 Set the cipher.
 +
-*Shadowsocks-libev* accepts 21 different ciphers:
+*Shadowsocks-libev* accepts 20 different ciphers:
 +
 table, rc4, rc4-md5, aes-128-cfb, aes-192-cfb, aes-256-cfb,
 aes-128-ctr, aes-192-ctr, aes-256-ctr, bf-cfb,
 camellia-128-cfb, camellia-192-cfb, camellia-256-cfb, cast5-cfb, des-cfb,
-idea-cfb, rc2-cfb, seed-cfb, salsa20, chacha20 and chacha20-ietf.
+idea-cfb, rc2-cfb, seed-cfb, salsa20 and chacha20.
 +
 The default cipher is 'rc4-md5'.
 +
diff --git a/src/encrypt.c b/src/encrypt.c
index d342485..c98bd69 100644
--- a/src/encrypt.c
+++ b/src/encrypt.c
@@ -121,8 +121,7 @@ static const char *supported_ciphers[CIPHER_NUM] = {
     "rc2-cfb",
     "seed-cfb",
     "salsa20",
-    "chacha20",
-    "chacha20-ietf"
+    "chacha20"
 };
 
 #ifdef USE_CRYPTO_POLARSSL
@@ -146,8 +145,7 @@ static const char *supported_ciphers_polarssl[CIPHER_NUM] = {
     CIPHER_UNSUPPORTED,
     CIPHER_UNSUPPORTED,
     "salsa20",
-    "chacha20",
-    "chacha20-ietf"
+    "chacha20"
 };
 #endif
 
@@ -172,8 +170,7 @@ static const char *supported_ciphers_mbedtls[CIPHER_NUM] = {
     CIPHER_UNSUPPORTED,
     CIPHER_UNSUPPORTED,
     "salsa20",
-    "chacha20",
-    "chacha20-ietf"
+    "chacha20"
 };
 #endif
 
@@ -198,7 +195,6 @@ static const CCAlgorithm supported_ciphers_applecc[CIPHER_NUM] = {
     kCCAlgorithmRC2,
     kCCAlgorithmInvalid,
     kCCAlgorithmInvalid,
-    kCCAlgorithmInvalid,
     kCCAlgorithmInvalid
 };
 
@@ -222,17 +218,16 @@ static const CCMode supported_modes_applecc[CIPHER_NUM] = {
     kCCModeCFB,
     kCCAlgorithmInvalid,
     kCCAlgorithmInvalid,
-    kCCAlgorithmInvalid,
     kCCAlgorithmInvalid
 };
 #endif
 
 static const int supported_ciphers_iv_size[CIPHER_NUM] = {
-    0, 0, 16, 16, 16, 16, 16, 16, 16, 8, 16, 16, 16, 8, 8, 8, 8, 16, 8, 8, 12
+    0, 0, 16, 16, 16, 16, 16, 16, 16, 8, 16, 16, 16, 8, 8, 8, 8, 16, 8, 8
 };
 
 static const int supported_ciphers_key_size[CIPHER_NUM] = {
-    0, 16, 16, 16, 24, 32, 16, 24, 32, 16, 16, 24, 32, 16, 8, 16, 16, 16, 32, 32, 32
+    0, 16, 16, 16, 24, 32, 16, 24, 32, 16, 16, 24, 32, 16, 8, 16, 16, 16, 32, 32
 };
 
 static int
@@ -292,8 +287,6 @@ crypto_stream_xor_ic(uint8_t *c, const uint8_t *m, uint64_t mlen,
         return crypto_stream_salsa20_xor_ic(c, m, mlen, n, ic, k);
     case CHACHA20:
         return crypto_stream_chacha20_xor_ic(c, m, mlen, n, ic, k);
-    case CHACHA20IETF:
-        return crypto_stream_chacha20_ietf_xor_ic(c, m, mlen, n, (uint32_t)ic, k);
     }
     // always return 0
     return 0;
@@ -1393,7 +1386,7 @@ enc_key_init(int method, const char *pass)
         FATAL("Failed to initialize sodium");
     }
 
-    if (method == SALSA20 || method == CHACHA20 || method == CHACHA20IETF) {
+    if (method == SALSA20 || method == CHACHA20) {
         // Fake cipher
         cipher = (cipher_kt_t *)&cipher_info;
 #if defined(USE_CRYPTO_OPENSSL)
diff --git a/src/encrypt.h b/src/encrypt.h
index 3ef7c46..c285d83 100644
--- a/src/encrypt.h
+++ b/src/encrypt.h
@@ -119,7 +119,7 @@ typedef struct {
 #endif
 
 #define SODIUM_BLOCK_SIZE   64
-#define CIPHER_NUM          21
+#define CIPHER_NUM          20
 
 #define NONE                -1
 #define TABLE               0
@@ -142,7 +142,6 @@ typedef struct {
 #define SEED_CFB            17
 #define SALSA20             18
 #define CHACHA20            19
-#define CHACHA20IETF        20
 
 #define ONETIMEAUTH_FLAG 0x10
 #define ADDRTYPE_MASK 0xEF
diff --git a/src/utils.c b/src/utils.c
index 367d4c2..39e12b8 100644
--- a/src/utils.c
+++ b/src/utils.c
@@ -250,9 +250,9 @@ usage()
     printf(
         "                                  camellia-256-cfb, cast5-cfb, des-cfb,\n");
     printf(
-        "                                  idea-cfb, rc2-cfb, seed-cfb, salsa20,\n");
+        "                                  idea-cfb, rc2-cfb, seed-cfb, salsa20 and\n");
     printf(
-        "                                  chacha20 and chacha20-ietf.\n");
+        "                                  chacha20.\n");
     printf(
         "                                  The default cipher is rc4-md5.\n");
     printf("\n");
