From: Vladimir Olteanu <vladimir.olteanu@cs.pub.ro>
Date: Fri, 15 Sep 2017 16:36:54 +0300
Subject: properly set recv_ctx->connected

(cherry picked from commit 82694c8f19a9cc39f4a7647c9e8764e5cc5a39bd)
---
 src/local.c  | 2 +-
 src/redir.c  | 2 +-
 src/server.c | 2 +-
 src/tunnel.c | 2 +-
 4 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/local.c b/src/local.c
index 177eaf6..570d8cd 100644
--- a/src/local.c
+++ b/src/local.c
@@ -955,8 +955,8 @@ remote_recv_cb(EV_P_ ev_io *w, int revents)
         int opt = 0;
         setsockopt(server->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
         setsockopt(remote->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
-        remote->recv_ctx->connected = 1;
     }
+    remote->recv_ctx->connected = 1;
 }
 
 static void
diff --git a/src/redir.c b/src/redir.c
index 17ec5cc..3cec8d0 100644
--- a/src/redir.c
+++ b/src/redir.c
@@ -442,8 +442,8 @@ remote_recv_cb(EV_P_ ev_io *w, int revents)
         int opt = 0;
         setsockopt(server->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
         setsockopt(remote->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
-        remote->recv_ctx->connected = 1;
     }
+    remote->recv_ctx->connected = 1;
 }
 
 static void
diff --git a/src/server.c b/src/server.c
index d2793c6..9f77c03 100644
--- a/src/server.c
+++ b/src/server.c
@@ -1147,8 +1147,8 @@ remote_recv_cb(EV_P_ ev_io *w, int revents)
         int opt = 0;
         setsockopt(server->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
         setsockopt(remote->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
-        remote->recv_ctx->connected = 1;
     }
+    remote->recv_ctx->connected = 1;
 }
 
 static void
diff --git a/src/tunnel.c b/src/tunnel.c
index f594741..9e6cd0d 100644
--- a/src/tunnel.c
+++ b/src/tunnel.c
@@ -382,8 +382,8 @@ remote_recv_cb(EV_P_ ev_io *w, int revents)
         int opt = 0;
         setsockopt(server->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
         setsockopt(remote->fd, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
-        remote->recv_ctx->connected = 1;
     }
+    remote->recv_ctx->connected = 1;
 }
 
 static void
