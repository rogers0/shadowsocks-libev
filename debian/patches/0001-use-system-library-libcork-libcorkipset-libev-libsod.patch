From: Roger Shimizu <rogershimizu@gmail.com>
Date: Wed, 25 May 2016 22:57:14 +0900
Subject: use system library: libcork libcorkipset libev libsodium libudns

autoreconf runs before configure, so it still doesn't have the condition
variable set yet.
Currently remove all system library part for configure.ac and Makefile.am
---
 Makefile.am     |  6 +-----
 configure.ac    | 20 --------------------
 src/Makefile.am | 10 ++++------
 3 files changed, 5 insertions(+), 31 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 690af43..8c1ec59 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,8 +1,4 @@
-if USE_SYSTEM_SHARED_LIB
-SUBDIRS = libcork libipset src
-else
-SUBDIRS = libsodium libcork libipset libudns libev src
-endif
+SUBDIRS = src
 
 if ENABLE_DOCUMENTATION
 SUBDIRS += doc
diff --git a/configure.ac b/configure.ac
index 69a8055..d06e145 100755
--- a/configure.ac
+++ b/configure.ac
@@ -76,11 +76,6 @@ AC_PROG_LIBTOOL
 AC_PROG_MAKE_SET
 AC_LANG_SOURCE
 
-dnl Checks for libev
-AM_COND_IF([USE_SYSTEM_SHARED_LIB],
-  [],
-  [m4_include([libev/libev.m4])])
-
 dnl Add library for mingw
 case $host in
   *-mingw*)
@@ -304,24 +299,9 @@ dnl Add define for libudns to enable IPv6 support
 dnl This is an option defined in the origin configure script
 AC_DEFINE([HAVE_IPv6], [1], [Enable IPv6 support in libudns])
 
-AM_COND_IF([USE_SYSTEM_SHARED_LIB],[
-    AC_CHECK_LIB([sodium], [sodium_init], ,[
-       AC_MSG_ERROR([Couldn't find libsodium. Try installing libsodium-dev@<:@el@:>@.])
-    ])
-  ],
-  [AC_CONFIG_SUBDIRS([libsodium])])
-
 AC_CONFIG_FILES([ shadowsocks-libev.pc
                  Makefile
-                 libcork/Makefile
-                 libipset/Makefile
                  src/Makefile])
-AM_COND_IF([USE_SYSTEM_SHARED_LIB],[
-    AC_CHECK_LIB([udns], [dns_dnlen], ,[AC_MSG_ERROR([Couldn't find libudns. Try installing libudns-dev or udns-devel.])])
-    AC_CHECK_LIB([ev], [ev_loop_destroy], ,[AC_MSG_ERROR([Couldn't find libev. Try installing libev-dev@<:@el@:>@.])])
-  ],
-  [AC_CONFIG_FILES([libudns/Makefile
-                 libev/Makefile])])
 
 AM_COND_IF([ENABLE_DOCUMENTATION],
   [AC_CONFIG_FILES([doc/Makefile])
diff --git a/src/Makefile.am b/src/Makefile.am
index b3c43f1..b03f903 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -6,16 +6,14 @@ if !USE_SYSTEM_SHARED_LIB
 AM_CFLAGS += -I$(top_srcdir)/libev
 AM_CFLAGS += -I$(top_srcdir)/libudns
 AM_CFLAGS += -I$(top_srcdir)/libsodium/src/libsodium/include
-endif
-AM_CFLAGS += -I$(top_srcdir)/libipset/include
 AM_CFLAGS += -I$(top_srcdir)/libcork/include
+AM_CFLAGS += -I$(top_srcdir)/libcorkipset/include
 AM_CFLAGS += $(LIBPCRE_CFLAGS)
+endif
 
-SS_COMMON_LIBS = $(top_builddir)/libipset/libipset.la \
-                 $(top_builddir)/libcork/libcork.la \
-                 $(INET_NTOP_LIB) $(LIBPCRE_LIBS)
+SS_COMMON_LIBS = $(INET_NTOP_LIB) $(LIBPCRE_LIBS)
 if USE_SYSTEM_SHARED_LIB
-SS_COMMON_LIBS += -lev -lsodium -lm
+SS_COMMON_LIBS += -lev -lsodium -lm -lcork -lcorkipset
 else
 SS_COMMON_LIBS += $(top_builddir)/libev/libev.la \
                   $(top_builddir)/libsodium/src/libsodium/libsodium.la
